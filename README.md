# åŒ»ç¾å®¢æˆ·å›è®¿ç³»ç»Ÿ (Revisit)

åŸºäº AI çš„æ™ºèƒ½åŒ»ç¾å®¢æˆ·å›è®¿ç³»ç»Ÿï¼Œæ”¯æŒå¤šæœºæ„ã€å¤šæ•°æ®åº“çš„ç»Ÿä¸€ç®¡ç†ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

1. **ç”Ÿæ—¥å›è®¿** - è‡ªåŠ¨è¯†åˆ«å³å°†ç”Ÿæ—¥çš„å®¢æˆ·ï¼Œä½¿ç”¨ LLM ç”Ÿæˆä¸ªæ€§åŒ–ç¥ç¦å’Œæ¨è
2. **å¤šæœºæ„ç®¡ç†** - æ”¯æŒåŒ»ç¾é›†å›¢ä¸‹å¤šå®¶æœºæ„ç‹¬ç«‹ç®¡ç†å®¢æˆ·
3. **æ•°æ®åŒæ­¥** - PostgreSQL ä¸»åº“ + NebulaGraph/Qdrant/ClickHouse å¤šåº“åŒæ­¥
4. **å®šæ—¶ä»»åŠ¡** - è‡ªåŠ¨åŒ–çš„å›è®¿ä»»åŠ¡è°ƒåº¦å’Œæ•°æ®å¯¼å…¥

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  æœºæ„ API   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®å¯¼å…¥å±‚                                   â”‚
â”‚  python -m scripts.import_data initial/incremental             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL  â”‚      â”‚NebulaGraph  â”‚      â”‚   Qdrant    â”‚
â”‚   (ä¸»æ•°æ®)   â”‚â”€â”€â”€â”€â”€â–¶â”‚  (å›¾å…³ç³»)   â”‚      â”‚  (å‘é‡æœç´¢) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ ClickHouse  â”‚
                      â”‚  (åˆ†æç»Ÿè®¡)  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å›è®¿æœåŠ¡å±‚                                   â”‚
â”‚  æŸ¥è¯¢ç”Ÿæ—¥å®¢æˆ· â†’ è·å–å®¢æˆ·ç”»åƒ â†’ LLMç”Ÿæˆè¯æœ¯ â†’ å‘é€é€šçŸ¥            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
Revisit/
â”œâ”€â”€ api/                    # FastAPI è·¯ç”±
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ customers.py    # å®¢æˆ·ç®¡ç† API
â”‚       â”œâ”€â”€ reminders.py    # å›è®¿ç®¡ç† API
â”‚       â””â”€â”€ analytics.py    # åˆ†æç»Ÿè®¡ API
â”œâ”€â”€ config/                 # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ settings.py
â”œâ”€â”€ database/               # æ•°æ®åº“è¿æ¥å’Œ Schema
â”‚   â”œâ”€â”€ postgres/
â”‚   â”œâ”€â”€ nebula/
â”‚   â”œâ”€â”€ qdrant/
â”‚   â””â”€â”€ clickhouse/
â”œâ”€â”€ services/               # ä¸šåŠ¡æœåŠ¡
â”‚   â”œâ”€â”€ birthday_reminder.py  # ç”Ÿæ—¥å›è®¿æœåŠ¡
â”‚   â”œâ”€â”€ data_sync.py          # æ•°æ®åŒæ­¥æœåŠ¡
â”‚   â”œâ”€â”€ llm_service.py        # LLM æœåŠ¡
â”‚   â””â”€â”€ notification_service.py  # é€šçŸ¥æœåŠ¡
â”œâ”€â”€ scripts/                # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ init_database.py    # åˆå§‹åŒ–æ•°æ®åº“
â”‚   â”œâ”€â”€ import_data.py      # å¯¼å…¥æ•°æ®
â”‚   â”œâ”€â”€ run_reminders.py    # è¿è¡Œå›è®¿
â”‚   â””â”€â”€ check_system.py     # ç³»ç»Ÿæ£€æŸ¥
â”œâ”€â”€ tasks/                  # å®šæ—¶ä»»åŠ¡
â”‚   â””â”€â”€ scheduler.py
â”œâ”€â”€ data/                   # æ•°æ®ç›®å½•
â”‚   â””â”€â”€ import/
â”‚       â”œâ”€â”€ initial/        # åˆå§‹æ•°æ®
â”‚       â””â”€â”€ incremental/    # å¢é‡æ•°æ®
â””â”€â”€ main.py                 # ä¸»å…¥å£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¯åŠ¨æ•°æ®åº“ï¼ˆä½¿ç”¨ Docker Composeï¼‰
docker-compose up -d
```

### 2. åˆå§‹åŒ–æ•°æ®åº“

```bash
python -m scripts.init_database
```

### 3. å¯¼å…¥æ•°æ®

```bash
# åˆå§‹å…¨é‡å¯¼å…¥
python -m scripts.import_data initial

# å¢é‡æ›´æ–°
python -m scripts.import_data incremental
```

### 4. è¿è¡Œç³»ç»Ÿæ£€æŸ¥

```bash
python -m scripts.check_system
```

### 5. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ API æœåŠ¡
python main.py

# æˆ–ä½¿ç”¨ uvicorn
uvicorn main:app --reload
```

### 6. è¿è¡Œå›è®¿ä»»åŠ¡

```bash
# æŸ¥çœ‹å³å°†ç”Ÿæ—¥çš„å®¢æˆ·
python -m scripts.run_reminders --report

# æµ‹è¯•æ¨¡å¼ï¼ˆä¸å‘é€æ¶ˆæ¯ï¼‰
python -m scripts.run_reminders --test

# è¿è¡Œå›è®¿
python -m scripts.run_reminders
```

## ğŸ“Š API æ–‡æ¡£

å¯åŠ¨æœåŠ¡åè®¿é—®ï¼š
- Swagger UI: http://localhost:8000/api/docs
- ReDoc: http://localhost:8000/api/redoc

### ä¸»è¦ API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/reminders/{inst}/upcoming-birthdays` | GET | è·å–å³å°†ç”Ÿæ—¥å®¢æˆ· |
| `/api/reminders/{inst}/run-birthday-reminders` | POST | è¿è¡Œç”Ÿæ—¥å›è®¿ |
| `/api/reminders/{inst}/generate-content` | POST | ç”Ÿæˆå›è®¿å†…å®¹ |
| `/api/customers/{inst}/list` | GET | è·å–å®¢æˆ·åˆ—è¡¨ |

## âš™ï¸ é…ç½®è¯´æ˜

ä¸»è¦é…ç½®åœ¨ `config/settings.py` å’Œ `.env` æ–‡ä»¶ï¼š

```env
# æ•°æ®åº“
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=revisit

# NebulaGraph
NEBULA_HOST=localhost
NEBULA_PORT=9669
NEBULA_SPACE=revisit

# LLM
OPENAI_API_KEY=your-api-key
OPENAI_API_BASE=https://api.deepseek.com
OPENAI_MODEL=deepseek-chat

# å›è®¿é…ç½®
BIRTHDAY_REMINDER_DAYS_AHEAD=7
INSTITUTIONS=BJ-HA-001,SH-ML-002
```

## ğŸ“ˆ å®šæ—¶ä»»åŠ¡

| ä»»åŠ¡ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| daily_reminders | æ¯å¤© 9:00 | è¿è¡Œç”Ÿæ—¥å›è®¿ |
| incremental_import | æ¯å°æ—¶ | æ£€æŸ¥å¢é‡æ•°æ®å¯¼å…¥ |
| health_check | æ¯30åˆ†é’Ÿ | ç³»ç»Ÿå¥åº·æ£€æŸ¥ |
| daily_report | æ¯å¤© 8:00 | ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š |

å¯åŠ¨è°ƒåº¦å™¨ï¼š
```bash
python -m tasks.scheduler
```

## ğŸ”§ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°æœºæ„

1. åœ¨ `settings.py` çš„ `INSTITUTIONS` æ·»åŠ æœºæ„ä»£ç 
2. åœ¨ `data/import/initial/institutions/` åˆ›å»ºæœºæ„ç›®å½•
3. æ·»åŠ  `customers.json` å’Œ `consumption_records.json`
4. è¿è¡Œ `python -m scripts.init_database` åˆ›å»ºæœºæ„è¡¨
5. è¿è¡Œ `python -m scripts.import_data initial` å¯¼å…¥æ•°æ®

### è‡ªå®šä¹‰å›è®¿ç±»å‹

ç»§æ‰¿ `BaseReminderService` å®ç°æ–°çš„å›è®¿æœåŠ¡ï¼Œå‚è€ƒ `BirthdayReminderService`ã€‚

## ğŸ“ License

MIT License

